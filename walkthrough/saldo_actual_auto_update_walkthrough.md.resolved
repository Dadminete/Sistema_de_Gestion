# Actualizaci√≥n Autom√°tica de Saldo en Cuentas Contables

## ‚úÖ Implementaci√≥n Completada

Se ha implementado exitosamente la funcionalidad para actualizar autom√°ticamente el campo `saldoActual` de las cuentas contables cuando se registran movimientos de ingresos o gastos.

---

## üîß Cambios T√©cnicos Realizados

### Archivo Modificado: [server/services/movimientoContableService.js](file:///e:/Web/DB_Sistema_2.0_NEON/server/services/movimientoContableService.js)

#### 1. **Nueva Funci√≥n Helper: [updateCuentaContableSaldo](file:///e:/Web/DB_Sistema_2.0_NEON/server/services/movimientoContableService.js#6-70)**

Esta funci√≥n se encarga de:
- Identificar la cuenta contable correcta bas√°ndose en el m√©todo de pago (caja, banco, gen√©rico)
- Calcular el nuevo saldo usando los movimientos existentes
- Actualizar el campo `saldoActual` en la base de datos

```javascript
const updateCuentaContableSaldo = async (categoriaId, metodo, cajaId = null, cuentaBancariaId = null) => {
  // Encuentra la cuenta contable seg√∫n el m√©todo
  // Calcula el nuevo saldo
  // Actualiza saldoActual en la BD
}
```

#### 2. **Integraci√≥n en Operaciones CRUD**

**‚úÖ CREATE** ([createMovimiento](file:///e:/Web/DB_Sistema_2.0_NEON/server/services/movimientoContableService.js#51-117)):
- Despu√©s de crear el movimiento y actualizar la caja
- Se actualiza autom√°ticamente el `saldoActual` de la cuenta contable asociada

**‚úÖ UPDATE** ([updateMovimiento](file:///e:/Web/DB_Sistema_2.0_NEON/server/services/movimientoContableService.js#192-245)):
- Actualiza la cuenta contable antigua (si cambi√≥ categor√≠a/m√©todo)
- Actualiza la nueva cuenta contable
- Maneja correctamente cambios de categor√≠a, m√©todo, caja o cuenta bancaria

**‚úÖ DELETE** ([deleteMovimiento](file:///e:/Web/DB_Sistema_2.0_NEON/server/services/movimientoContableService.js#149-167)):
- Despu√©s de eliminar el movimiento
- Se recalcula y actualiza el `saldoActual` de la cuenta contable

---

## üìã C√≥mo Funciona

### Escenario 1: Registrar un Ingreso

**Antes:**
```
Cuenta Contable: "Ingresos por Servicios"
- saldoActual: $0.00 (no se actualizaba)
```

**Acci√≥n:** Crear movimiento contable
- Tipo: Ingreso
- Monto: $1,500.00
- Categor√≠a: "Ingresos por Servicios" (4.1)
- M√©todo: Caja

**Despu√©s (autom√°tico):**
```
Cuenta Contable: "Ingresos por Servicios"
- saldoActual: $1,500.00 ‚ú® (actualizado autom√°ticamente)
```

### Escenario 2: Registrar un Gasto

**Antes:**
```
Cuenta Contable: "Gastos Operativos - Salarios"
- saldoActual: $0.00
```

**Acci√≥n:** Crear movimiento contable
- Tipo: Gasto
- Monto: $850.00
- Categor√≠a: "Salarios y N√≥mina" (5.1.1)
- M√©todo: Banco

**Despu√©s (autom√°tico):**
```
Cuenta Contable: "Gastos Operativos - Salarios"
- saldoActual: -$850.00 ‚ú® (actualizado autom√°ticamente)
```

---

## üîç L√≥gica de Identificaci√≥n de Cuenta Contable

La funci√≥n determina qu√© cuenta contable actualizar seg√∫n el m√©todo:

1. **M√©todo: Caja** (`metodo === 'caja'`)
   - Busca la cuenta contable asociada a la caja
   - Obtiene `cuentaContableId` desde la tabla `cajas`

2. **M√©todo: Banco** (`metodo === 'banco'`)
   - Busca la cuenta contable asociada a la cuenta bancaria
   - Obtiene `cuentaContableId` desde la tabla `cuentas_bancarias`

3. **M√©todo: Gen√©rico/Otros**
   - Busca la cuenta contable por categor√≠a
   - Encuentra la primera cuenta contable con ese `categoriaId`

---

## üß™ C√≥mo Probar

### Prueba 1: Crear Ingreso en Caja
1. Ve a `/contabilidad/ingresos-gastos`
2. Registra un ingreso:
   - Tipo: Ingreso
   - Categor√≠a: "Ingresos por Servicios de Internet"
   - M√©todo: Caja
   - Monto: $2,000.00
3. Ve a `/contabilidad/cuentas-contables`
4. ‚úÖ Verifica que la cuenta contable muestre el nuevo `saldoActual`

### Prueba 2: Crear Gasto en Banco
1. Ve a `/contabilidad/ingresos-gastos`
2. Registra un gasto:
   - Tipo: Gasto
   - Categor√≠a: "Alquiler"
   - M√©todo: Banco
   - Selecciona una cuenta bancaria
   - Monto: $1,200.00
3. Ve a `/contabilidad/cuentas-contables`
4. ‚úÖ Verifica que la cuenta contable asociada muestre el gasto reflejado

### Prueba 3: Editar Movimiento
1. Edita un movimiento existente y cambia el monto
2. Ve a `/contabilidad/cuentas-contables`
3. ‚úÖ Verifica que el `saldoActual` se haya recalculado correctamente

### Prueba 4: Eliminar Movimiento
1. Elimina un movimiento contable
2. Ve a `/contabilidad/cuentas-contables`
3. ‚úÖ Verifica que el `saldoActual` se haya actualizado sin ese movimiento

---

## üìä Consola de Logs

La implementaci√≥n incluye logs para debugging:

```
[UpdateSaldo] Updated cuenta contable <uuid> - New balance: 1500.50
[UpdateSaldo] No cuenta contable found for categoria: <uuid>, metodo: caja
[UpdateSaldo] Error updating cuenta contable saldo: <error details>
```

Revisa la consola del servidor para ver estos logs cuando se registren movimientos.

---

## ‚ö†Ô∏è Consideraciones Importantes

1. **Rendimiento**: La actualizaci√≥n es as√≠ncrona pero se ejecuta inmediatamente despu√©s de cada operaci√≥n
2. **Consistencia**: El saldo siempre se recalcula desde cero sumando todos los movimientos
3. **Relaci√≥n con Cajas**: Las cajas tienen su propia l√≥gica de actualizaci√≥n que se mantiene intacta
4. **Cuentas Bancarias**: Se actualizan tanto los movimientos como los pagos de clientes

---

## ‚ú® Beneficios

- ‚úÖ **Datos en tiempo real**: El `saldoActual` siempre est√° actualizado en la BD
- ‚úÖ **Consultas m√°s r√°pidas**: No necesitas calcular el saldo cada vez que consultas
- ‚úÖ **Consistencia**: Garantiza que la informaci√≥n financiera sea precisa
- ‚úÖ **Reportes confiables**: Los reportes contables usan datos actualizados

---

## üéØ Pr√≥ximos Pasos Recomendados

1. Probar con diferentes categor√≠as de ingresos y gastos
2. Verificar que los reportes contables usen el `saldoActual` actualizado
3. Considerar agregar un script de sincronizaci√≥n para recalcular todos los saldos existentes (opcional)
